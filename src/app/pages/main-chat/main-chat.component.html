<section class="row">
  <div class="col-3  px-0  position-relative  area-search d-none d-lg-block">
    <div class="z-3  px-3 rounded-bottom-1 position-fixed   main-area-search ">
      <p class="pt-3 fw-bolder fs-4">{{'chatMessages.chats' |translate }}</p>
      <input type="search" class="form-control mb-2 " [(ngModel)]="searchText" placeholder="search..." />
    </div>
    <div class="SideAllChats overflow-x-hidden">
      @for (chat of AllChats | chatSearch : searchText; track chat._id) {
      <div class="row ">
        @if(chat.user1._id === currentChat){
        <div class="col-12">
          <div class="m-2 rounded-1 shadow-light cursor-pointer p-2"
            (click)="divCilcked(chat.user1._id , chat.messages[chat.messages.length - 1]._id)" (click)="reload()">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <p class="fw-bolder mb-0">{{chat.user1.email}}</p>
              <small class="timeComment fw-bolder">
                {{ formatMessageTime(chat.messages[chat.messages.length - 1].timestamp) }}
              </small>
            </div>
            <p class="mb-0 text-truncate">{{ chat.messages[chat.messages.length - 1]?.message }}</p>
          </div>
        </div>
        } @else {
        <div class="col-12">
          <div class="inner m-2 chatHoverd rounded-1  cursor-pointer p-2"
            (click)="divCilcked(chat.user1._id , chat.messages[chat.messages.length - 1]._id)" (click)="reload()">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <p class="fw-bolder mb-0">{{chat.user1.email}}</p>
              <small class="timeComment fw-bolder">
                {{ formatMessageTime(chat.messages[chat.messages.length - 1].timestamp) }}
              </small>
            </div>
            <p class="mb-0 text-truncate">{{ chat.messages[chat.messages.length - 1]?.message }}</p>
          </div>
        </div>
        }
      </div>
      }
      @if (searchText !== '') {
      <p class="px-3 fw-bolder fs-4">{{'chatMessages.messages' |translate }}</p>
      }
      @for (data of messagesSearch; track $index) {
      @if(data.message.includes(searchText) && searchText !== '') {
      <div class="inner  chatHoverd overflow-x-hidden rounded-1 p-2 cursor-pointer m-2 mb-3"
        (click)="divCilcked(data.userId , data.messageId)" (click)="reload()">
        <p class="mb-0 fw-bolder">{{ data.email }}</p>
        <div class="d-flex">
          @if(data.isSender === true) {
          <p class="my-1">
            <span class="mb-0 my-1 rounded-1 breakMessage w-fit">
              You: {{ data.message.slice(0, 15) }} ...
            </span>
          </p>
          } @else {
          <p class="my-1">
            <span class="mb-0 my-1 rounded-1 breakMessage w-fit">
              Customer: {{ data.message.slice(0, 15) }} ...
            </span>
          </p>
          }
        </div>
        <div class="d-flex justify-content-between">
          <small class="mb-0 timeComment fw-bolder">
            @let hour = +data.timestamp.split('T')[1].slice(0, 2);
            @let minute = data.timestamp.split('T')[1].slice(3, 5);
            @if (hour + 3 >= 24) {
            {{ ((hour + 3) % 24 === 0 ? 12 : (hour + 3) % 24) }}:{{ minute }}{{ 'notifications.AM' | translate }}
            } @else if (hour + 3 === 12) {
            12:{{ minute }}{{ 'notifications.PM' | translate }}
            } @else if (hour + 3 < 12) { {{ hour + 3 }}:{{ minute }}{{ 'notifications.AM' | translate }} } @else if
              (hour + 3> 12 && hour + 3 < 24) { {{ hour + 3 - 12 }}:{{ minute }}{{ 'notifications.PM' | translate }} }
                </small>
                <p class="mb-0 timeComment fw-bolder">
                  {{ data.timestamp.split('T')[0].split('-')[2] }}/{{ data.timestamp.split('T')[0].split('-')[1] }}/{{
                  data.timestamp.split('T')[0].split('-')[0] }}
                </p>
        </div>
      </div>
      }
      }

    </div>
  </div>
  <div class="col-12 px-0 col-lg-9  position-relative " >
    <div class="inner d-flex py-2  flex-column  position-fixed container z-3">
      <p class=" cursor-pointer mb-0 w-100 my-1 mx-auto " title="View Profile"> <span class="fw-bolder">
          {{"registration.customer" | translate}} :
        </span> {{customerName}} </p>
      <p class=" cursor-pointer mb-0 w-100 my-1 mx-auto " title="View Profile"> <span class="fw-bolder">
          {{"chatMessages.emailDot" | translate}} </span>
        {{userEmail}} </p>
    </div>
    <div class="flex-grow-1 messages overflow-auto px-3 mb-5 " style="padding-bottom: 120px;" #messagesContainer (scroll)="onScroll($event)">
      @for(msg of messages; track $index) {
      <div class="d-flex mb-2 " [class]="{'justify-content-end': msg.sender._id === senderId,
                    'justify-content-start': msg.sender._id !== senderId}">
        <p class="rounded  px-2 py-1 d-flex flex-column justify-content-center w-fit message" [class]="{'sender-bg': msg.sender._id === senderId,
                    'reciver-bg': msg.sender._id !== senderId}">
          @if(msg._id === lastMessageToGoID){
          <span class="breakMessage targetMessage ">{{ msg.message }} </span>
          }@else {
          <span class="breakMessage">{{ msg.message }}</span>
          }
          <small class="time timeComment  justify-content-end  d-flex">
            @if (+msg.timestamp.split('').slice(11 , 13).join('') + 3 >= 24) {
            {{((+msg.timestamp.split('').slice(11 , 13).join('') + 3 ) % 24 === 0 ? 12 :
            (+msg.timestamp.split('').slice(11 , 13).join('') + 3 ) % 24)
            }}:{{msg.timestamp.split('').slice(14
            , 16).join('')}}{{'notifications.AM' | translate}}
            }
            @else if (+msg.timestamp.split('').slice(11 , 13).join('') + 3 === 12) {
            12:{{msg.timestamp.split('').slice(14 , 16).join('')}}{{'notifications.PM' | translate}}
            }
            @else if (+msg.timestamp.split('').slice(11 , 13).join('') + 3 < 12) { {{+msg.timestamp.split('').slice(11 ,
              13).join('') + 3 }}:{{msg.timestamp.split('').slice(14 , 16).join('')}}{{'notifications.AM' | translate}}
                } @else if (+msg.timestamp.split('').slice(11 , 13).join('') + 3> 12 &&
                +msg.timestamp.split('').slice(11 , 13).join('') + 3 < 24) { {{(+msg.timestamp.split('').slice(11 ,
                  13).join('') + 3 - 12 )}}:{{msg.timestamp.split('').slice(14 , 16).join('')}}{{'notifications.PM' |
                  translate}} }
          </small>
        </p>
      </div>
      }
      @if(showGoToBottom) {
      <div class="w-100 d-flex justify-content-end position-absolute toEndChat">
        <div class="d-flex justify-content-center align-items-center w-fit p-1 rounded-1 parentIconGoDown" (click)="scrollToBottom()">
          <i class="fa-solid fa-angle-down cursor-pointer fs-4" title="Go To Bottom"></i>
        </div>
      </div>
      }
    </div>
    <div class="position-fixed bottom-0 col-12 col-lg-9 px-3 py-2 inner rounded-top-1 shadow" style="z-index: 10;">
      <form [formGroup]="formMessage" (ngSubmit)="sendMessage()" class="d-flex align-items-center gap-2 w-100">
        <textarea [(ngModel)]="messageText" formControlName="message"
          class="form-control flex-grow-1 border-0 shadow-none px-3 py-2  bg-light"
          [placeholder]="'main-chat.placeHolder' | translate" rows="1" style="resize: none; overflow-y: auto;"
          (input)="adjustTextarea($event)">
    </textarea>
        @if(currentLang === 'en') {
        <button
          class="bg-transparent editButtonHoverColor rounded-1  border-0 d-flex justify-content-center align-items-center"
          style="width: 42px; height: 42px;" title="Tap To send Message">
          <i class="fa-solid fa-paper-plane editSend"></i>
        </button>
        } @else if (currentLang === 'ar') {
        <button class="bg-transparent rounded-1 border-0 d-flex justify-content-center align-items-center"
          style="width: 42px; height: 42px;">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
        }
      </form>
    </div>

  </div>
</section>
